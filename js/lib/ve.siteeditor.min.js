try{if(!Nabu){throw"Nabu Manager not loaded"}}catch(e){throw"Nabu Manager not loaded"}if(typeof Nabu.VisualEditor==="undefined"){Nabu.VisualEditor=function(){}}Nabu.VisualEditor.SiteEditor=function(a,b){Nabu.VisualEditor.Editor.call(this,a,b);this.id=null};nabu.registerLibrary("VE.SiteEditor",["VE.Editor","VE.Modals","Modal"],function(){nabu.extend(Nabu.VisualEditor.SiteEditor,Nabu.VisualEditor.Editor);Nabu.VisualEditor.SiteEditor.prototype.init=function(){var a=Nabu.VisualEditor.Editor.prototype.init.apply(this);var b=this;this.addEventListener(new Nabu.Event({onCellsResized:function(c){if(c.params.properties.cells.length>0){b.saveCellsGeometry(c.params.properties.cells)}},onCellsMoved:function(c){if(c.params.properties.cells.length>0){b.saveCellsGeometry(c.params.properties.cells)}},onCellsConnected:function(g){var i=g.params.properties.edge.objectId?g.params.properties.edge.objectId:null;var h=(g.params.properties.edge.source!==null&&g.params.properties.edge.source.objectId)?g.params.properties.edge.source.objectId:null;var d=(g.params.properties.edge.source!==null&&g.params.properties.edge.source.type)?g.params.properties.edge.source.type:null;var c=(g.params.properties.edge.target!==null&&g.params.properties.edge.target.objectId)?g.params.properties.edge.target.objectId:null;var f=(g.params.properties.edge.target!==null&&g.params.properties.edge.target.type)?g.params.properties.edge.target.type:null;if((d==="page"||d==="page-multi"||d==="document"||d==="document-multi")&&(f==="page"||f==="page-multi"||f==="document"||f==="document-multi")){i=b.saveCTAConnection(i,h,c);if(i!==null){g.params.properties.edge.id="cta-"+i;g.params.properties.edge.type="cta";g.params.properties.edge.objectId=i*1;b.saveCellsGeometry([g.params.properties.edge])}else{throw"Invalid ID returned"}}},onPopupMenu:function(f){var g=f.source;var c=f.params.cell;var d=f.params.evt;if(c===null){b.fillBackgroundPopupMenu(g,d)}else{if(c.type){switch(c.type){case"page":b.fillPagePopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"page-multi":b.fillPageMultiPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"document":b.fillDocumentPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"document-multi":b.fillDocumentMultiPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break}if(c.objectId){g.addSeparator();g.addItem("ID: #"+c.objectId,null,null,null,null,false,false)}}}}}));return a};Nabu.VisualEditor.SiteEditor.prototype.fillBackgroundPopupMenu=function(c,k){var b=$("#ve_remote_modal_container");if(b.length!==1){throw"Remote Modals container not found"}var d=this;var l=this.editor.graph;var g=l.getModel();var j=l.getDefaultParent();var i=l.getPointForEvent(k);var f=new Nabu.VisualEditor.Modals.SiteTarget();var h=new Nabu.VisualEditor.Modals.SiteMap();var a=c.addItem("Nuevo",null,null);c.addItem("Página",null,function(){f.newPage(d,b,l,i)},a);c.addItem("Página Múltiple",null,function(){f.newPageMulti(d,b,l,i)},a);c.addSeparator(a);c.addItem("Documento",null,function(){f.newDocument(d,b,l,i)},a);c.addItem("Documento Múltiple",null,function(){f.newDocumentMulti(d,b,l,i)},a);c.addSeparator(a);c.addItem("Grupo de páginas",null,function(){h.newMap(d,b,l,i)},a)};Nabu.VisualEditor.SiteEditor.prototype.fillCommonVertexPopupMenu=function(g,a,b){var f=this.editor.graph;var c=f.getModel();var d=g.addItem("Orden",null,null);g.addItem("Enviar al fondo",null,function(){var h=a.getParent();if(h!==null){c.beginUpdate();a.removeFromParent();h.insert(a,0);c.endUpdate();f.graphModelChanged([h,a])}},d);g.addItem("Traer al frente",null,function(){var h=a.getParent();if(h!==null){c.beginUpdate();a.removeFromParent();h.insert(a);c.endUpdate();f.graphModelChanged([h,a])}},d)};Nabu.VisualEditor.SiteEditor.prototype.fillSiteTargetContentPopupSubmenu=function(f,n){var c=$("#ve_remote_modal_container");if(c.length!==1){throw"Remote Modals container not found"}var g=this;var o=this.editor.graph;var l=o.getModel();var k=new Nabu.VisualEditor.Modals.SiteTarget();var a=f.addItem("Contenido",null,null);f.addItem("Principal",null,function(){k.mainContent(g,c,l,n)},a);var h=f.addItem("Secciones",null,null,a);f.addItem("Nueva sección",null,function(){k.section(g,c,l,n)},h);if(n.section_ids&&n.section_ids!==null&&n.section_ids.length>0){f.addSeparator(h);for(var j=0;j<n.section_ids.length;j++){var d=n.section_ids[j];var b=n.section_names[j];var p=f.addItem(b,null,function(i){var q=$(i.target).closest("tr").data("id");k.section(g,c,l,n,q)},h);$(p).data("id",d)}f.addSeparator(h);f.addItem("Eliminar secciones",null,function(i){k.removeSections(g,c,l,n)},h)}f.addSeparator(a);if(n.type==="page"||n.type==="page-multi"){f.addItem("SEO",null,function(){k.seo(g,c,l,n)},a)}f.addItem("URL",null,function(){k.url(g,c,l,n)});var m=f.addItem("SDK",null,null);f.addItem("Identificación",null,function(){k.sdkIdentity(g,c,l,n)},m);f.addSeparator(m);f.addItem("HTML",null,function(){k.sdkHTML(g,c,l,n)},m);f.addItem("PHP / Framework",null,function(){k.sdkPHP(g,c,l,n)},m);f.addItem("Smarty",null,function(){k.sdkSmarty(g,c,l,n)},m)};Nabu.VisualEditor.SiteEditor.prototype.fillPagePopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillPageMultiPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillDocumentPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillDocumentMultiPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.setId=function(a){this.id=a};Nabu.VisualEditor.SiteEditor.prototype.encodeGeometry=function(b){data={id:b.id,x:b.geometry.x,y:b.geometry.y,width:b.geometry.width,height:b.geometry.height,points:{source:null,target:null,intermediate:null}};var f=b.geometry;if(f.sourcePoint||f.targetPoint||f.points){var d=data.points;if(f.sourcePoint){d.source={x:f.sourcePoint.x,y:f.sourcePoint.y}}if(f.targetPoint){d.target={x:f.targetPoint.x,y:f.targetPoint.y}}if(f.points){d.intermediate=new Array();for(var c in f.points){var a=f.points[c];d.intermediate.push({x:a.x,y:a.y})}}data.points=d}return data};Nabu.VisualEditor.SiteEditor.prototype.saveCellsGeometry=function(d){if(this.id!==null){var b=[];for(var c in d){var h=d[c];b.push(this.encodeGeometry(h));if(h.edges!==null&&h.edges.length>0){for(var a in h.edges){var f=h.edges[a];b.push(this.encodeGeometry(f))}}}var g=new Nabu.Ajax.Connector("/api/site/"+this.id+"/visual-editor/cell/?action=mass-geometry","POST",{headerAccept:"application/json",contentType:"application/json",synchronous:true});g.addEventListener(new Nabu.Event({onLoad:function(i){return true}}));g.setPostJSON(b);g.execute()}else{throw"Site Editor requires a valid Id to save entities."}};Nabu.VisualEditor.SiteEditor.prototype.saveCTAConnection=function(d,b,c){if(this.id!==null){var a=new Nabu.Ajax.Connector("/api/site/"+this.id+"/visual-editor/cell/?action=set-cta","POST",{headerAccept:"application/json",contentType:"application/json",synchronous:true});a.addEventListener(new Nabu.Event({onLoad:function(f){var g=f.params.json.data;d=g.id;return true}}));a.setPostJSON({id:d,source_id:b,target_id:c});a.execute()}else{throw"Site Editor requires a valid Id to save entities."}return d}});