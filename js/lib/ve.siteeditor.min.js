try{if(!Nabu){throw"Nabu Manager not loaded"}}catch(e){throw"Nabu Manager not loaded"}if(typeof Nabu.VisualEditor==="undefined"){Nabu.VisualEditor=function(){}}Nabu.VisualEditor.SiteEditor=function(a,b){Nabu.VisualEditor.Editor.call(this,a,b);this.id=null};nabu.registerLibrary("VE.SiteEditor",["VE.Editor","VE.Modals","Modal"],function(){nabu.extend(Nabu.VisualEditor.SiteEditor,Nabu.VisualEditor.Editor);Nabu.VisualEditor.SiteEditor.prototype.init=function(){var a=Nabu.VisualEditor.Editor.prototype.init.apply(this);var b=this;this.addEventListener(new Nabu.Event({onCellsResized:function(c){if(c.params.properties.cells.length>0){b.saveCellsGeometry(c.params.properties.cells)}},onCellsMoved:function(c){if(c.params.properties.cells.length>0){b.saveCellsGeometry(c.params.properties.cells)}},onCellsConnected:function(d){var g=d.params.properties.edge.objectId?d.params.properties.edge.objectId:null;var f=(d.params.properties.edge.source!==null&&d.params.properties.edge.source.objectId)?d.params.properties.edge.source.objectId:null;var c=(d.params.properties.edge.target!==null&&d.params.properties.edge.target.objectId)?d.params.properties.edge.target.objectId:null;g=b.saveCTAConnection(g,f,c);if(g!==null){d.params.properties.edge.id="cta-"+g;d.params.properties.edge.type="cta";d.params.properties.edge.objectId=g*1;b.saveCellsGeometry([d.params.properties.edge])}else{throw"Invalid ID returned"}},onPopupMenu:function(f){var g=f.source;var c=f.params.cell;var d=f.params.evt;if(c===null){b.fillBackgroundPopupMenu(g,d)}else{if(c.type){switch(c.type){case"page":b.fillPagePopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"page-multi":b.fillPageMultiPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"document":b.fillDocumentPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break;case"document-multi":b.fillDocumentMultiPopupMenu(g,c,d);g.addSeparator();b.fillCommonVertexPopupMenu(g,c,d);break}}}}}));return a};Nabu.VisualEditor.SiteEditor.prototype.fillBackgroundPopupMenu=function(c,j){var b=$("#ve_remote_modal_container");if(b.length!==1){throw"Remote Modals container not found"}var f=this;var k=this.editor.graph;var g=k.getModel();var i=k.getDefaultParent();var h=k.getPointForEvent(j);var d=new Nabu.VisualEditor.Modals.SiteTarget();var a=c.addItem("Nuevo",null,null);c.addItem("Página",null,function(){d.newPage(f,b,k,h)},a);c.addItem("Página Múltiple",null,function(){d.newPageMulti(f,b,k,h)},a);c.addSeparator(a);c.addItem("Documento",null,function(){d.newDocument(f,b,k,h)},a);c.addItem("Documento Múltiple",null,function(){d.newDocumentMulti(f,b,k,h)},a)};Nabu.VisualEditor.SiteEditor.prototype.fillCommonVertexPopupMenu=function(g,a,b){var f=this.editor.graph;var c=f.getModel();var d=g.addItem("Orden",null,null);g.addItem("Enviar al fondo",null,function(){var h=a.getParent();if(h!==null){c.beginUpdate();a.removeFromParent();h.insert(a,0);c.endUpdate();f.graphModelChanged([h,a])}},d);g.addItem("Traer al frente",null,function(){var h=a.getParent();if(h!==null){c.beginUpdate();a.removeFromParent();h.insert(a);c.endUpdate();f.graphModelChanged([h,a])}},d)};Nabu.VisualEditor.SiteEditor.prototype.fillSiteTargetContentPopupSubmenu=function(f,m){var c=$("#ve_remote_modal_container");if(c.length!==1){throw"Remote Modals container not found"}var h=this;var n=this.editor.graph;var l=n.getModel();var g=new Nabu.VisualEditor.Modals.SiteTarget();var a=f.addItem("Contenido",null,null);f.addItem("Principal",null,function(){g.mainContent(h,c,l,m)},a);var j=f.addItem("Secciones",null,null,a);f.addItem("Nueva sección",null,function(){},j);console.log(m);if(m.section_ids&&m.section_ids!==null&&m.section_ids.length>0){f.addSeparator(j);for(var k=0;k<m.section_ids.length;k++){var d=m.section_ids[k];var b=m.section_names[k];var o=f.addItem(b,null,function(i){var p=$(i.target).closest("tr").data("id");g.section(h,c,l,m,p)},j);$(o).data("id",d)}}f.addSeparator(a);if(m.type==="page"||m.type==="page-multi"){f.addItem("SEO",null,function(){g.seo(h,c,l,m)},a)}f.addItem("URL",null,function(){g.url(h,c,l,m)})};Nabu.VisualEditor.SiteEditor.prototype.fillPagePopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillPageMultiPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillDocumentPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.fillDocumentMultiPopupMenu=function(c,a,b){this.fillSiteTargetContentPopupSubmenu(c,a)};Nabu.VisualEditor.SiteEditor.prototype.setId=function(a){this.id=a};Nabu.VisualEditor.SiteEditor.prototype.encodeGeometry=function(b){data={id:b.id,x:b.geometry.x,y:b.geometry.y,width:b.geometry.width,height:b.geometry.height,points:{source:null,target:null,intermediate:null}};var f=b.geometry;if(f.sourcePoint||f.targetPoint||f.points){var d=data.points;if(f.sourcePoint){d.source={x:f.sourcePoint.x,y:f.sourcePoint.y}}if(f.targetPoint){d.target={x:f.targetPoint.x,y:f.targetPoint.y}}if(f.points){d.intermediate=new Array();for(var c in f.points){var a=f.points[c];d.intermediate.push({x:a.x,y:a.y})}}data.points=d}return data};Nabu.VisualEditor.SiteEditor.prototype.saveCellsGeometry=function(d){if(this.id!==null){var b=[];for(var c in d){var h=d[c];b.push(this.encodeGeometry(h));if(h.edges!==null&&h.edges.length>0){for(var a in h.edges){var f=h.edges[a];b.push(this.encodeGeometry(f))}}}var g=new Nabu.Ajax.Connector("/api/site/"+this.id+"/visual-editor/cell/?action=mass-geometry","POST",{headerAccept:"application/json",contentType:"application/json",synchronous:true});g.addEventListener(new Nabu.Event({onLoad:function(i){return true}}));g.setPostJSON(b);g.execute()}else{throw"Site Editor requires a valid Id to save entities."}};Nabu.VisualEditor.SiteEditor.prototype.saveCTAConnection=function(d,b,c){if(this.id!==null){var a=new Nabu.Ajax.Connector("/api/site/"+this.id+"/visual-editor/cell/?action=set-cta","POST",{headerAccept:"application/json",contentType:"application/json",synchronous:true});a.addEventListener(new Nabu.Event({onLoad:function(f){var g=f.params.json.data;d=g.id;return true}}));a.setPostJSON({id:d,source_id:b,target_id:c});a.execute()}else{throw"Site Editor requires a valid Id to save entities."}return d}});